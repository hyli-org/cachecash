FROM rust:bookworm AS builder

RUN apt-get update && apt-get -y install curl g++ git libssl-dev pkg-config

RUN if ! /root/.sp1/bin/cargo-prove prove -V 2>/dev/null | grep -q "38f0f14"; then \
    curl -L https://sp1up.succinct.xyz | bash && /root/.sp1/bin/sp1up; \
fi

WORKDIR /app
COPY ./server ./server
COPY ./pkg ./pkg/
COPY ./fixtures/ ./fixtures/
COPY ./elf/ ./elf/
COPY ./contracts/ ./contracts/
COPY Cargo.toml . 
COPY Cargo.lock .

RUN cargo build --release -F nonreproducible -F nobuild --bin server

# RUNNER
FROM rust:latest

WORKDIR /app

COPY --from=builder /app/target/release/server ./

RUN apt-get update && apt-get -y install ca-certificates && apt-get clean && rm -rf /var/lib/apt/lists/*

EXPOSE 9002

CMD ["./server"]

