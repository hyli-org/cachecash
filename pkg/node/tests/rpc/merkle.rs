use std::sync::Arc;

use element::Element;
use expect_test::expect;
use testutil::eth::EthNode;

use crate::rpc::{ServerConfig, mint, rollup_contract};

use super::usdc_contract;

#[tokio::test(flavor = "multi_thread")]
async fn merkle() {
    let eth_node = EthNode::default().run_and_deploy().await;
    let server =
        super::Server::setup_and_wait(ServerConfig::single_node(false), Arc::clone(&eth_node))
            .await;
    let rollup = rollup_contract(server.rollup_contract_addr, &eth_node).await;
    let usdc = usdc_contract(&rollup, &eth_node).await;

    let (note, eth_mint_tx, tx) = mint(
        &rollup,
        &usdc,
        &server,
        Element::new(1),
        Element::from(100u64),
        Element::ZERO,
    );
    eth_mint_tx.await.unwrap();
    tx.await.unwrap();

    let res = server.merkle(&[note.commitment()]).await.unwrap();

    // TODO: the note is now random, so the path will be different each time
    let expected_paths = expect![[r#"
        [
            [
                0x0,
                0xb63a53787021a4a962a452c2921b3663aff1ffd8d5510540f8e659e782956f1,
                0xe34ac2c09f45a503d2908bcb12f1cbae5fa4065759c88d501c097506a8b2290,
                0x21f9172d72fdcdafc312eee05cf5092980dda821da5b760a9fb8dbdf607c8a20,
                0x2373ea368857ec7af97e7b470d705848e2bf93ed7bef142a490f2119bcf82d8e,
                0x120157cfaaa49ce3da30f8b47879114977c24b266d58b0ac18b325d878aafddf,
                0x1c28fe1059ae0237b72334700697bdf465e03df03986fe05200cadeda66bd76,
                0x2d78ed82f93b61ba718b17c2dfe5b52375b4d37cbbed6f1fc98b47614b0cf21b,
                0x67243231eddf4222f3911defbba7705aff06ed45960b27f6f91319196ef97e1,
                0x1849b85f3c693693e732dfc4577217acc18295193bede09ce8b97ad910310972,
                0x2a775ea761d20435b31fa2c33ff07663e24542ffb9e7b293dfce3042eb104686,
                0xf320b0703439a8114f81593de99cd0b8f3b9bf854601abb5b2ea0e8a3dda4a7,
                0xd07f6e7a8a0e9199d6d92801fff867002ff5b4808962f9da2ba5ce1bdd26a73,
                0x1c4954081e324939350febc2b918a293ebcdaead01be95ec02fcbe8d2c1635d1,
                0x197f2171ef99c2d053ee1fb5ff5ab288d56b9b41b4716c9214a4d97facc4c4a,
                0x2b9cdd484c5ba1e4d6efcc3f18734b5ac4c4a0b9102e2aeb48521a661d3feee9,
                0x14f44d672eb357739e42463497f9fdac46623af863eea4d947ca00a497dcdeb3,
                0x71d7627ae3b2eabda8a810227bf04206370ac78dbf6c372380182dbd3711fe3,
                0x2fdc08d9fe075ac58cb8c00f98697861a13b3ab6f9d41a4e768f75e477475bf5,
                0x20165fe405652104dceaeeca92950aa5adc571b8cafe192878cba58ff1be49c5,
                0x1c8c3ca0b3a3d75850fcd4dc7bf1e3445cd0cfff3ca510630fd90b47e8a24755,
                0x1f0c1a8fb16b0d2ac9a146d7ae20d8d179695a92a79ed66fc45d9da4532459b3,
                0x38146ec5a2573e1c30d2fb32c66c8440f426fbd108082df41c7bebd1d521c30,
                0x17d3d12b17fe762de4b835b2180b012e808816a7f2ff69ecb9d65188235d8fd4,
                0xe1a6b7d63a6e5a9e54e8f391dd4e9d49cdfedcbc87f02cd34d4641d2eb30491,
                0x9244eec34977ff795fc41036996ce974136377f521ac8eb9e04642d204783d2,
                0x1646d6f544ec36df9dc41f778a7ef1690a53c730b501471b6acd202194a7e8e9,
                0x64769603ba3f6c41f664d266ecb9a3a0f6567cd3e48b40f34d4894ee4c361b3,
                0x1595bb3cd19f84619dc2e368175a88d8627a7439eda9397202cdb1167531fd3f,
                0x2a529be462b81ca30265b558763b1498289c9d88277ab14f0838cb1fce4b472c,
                0xc08da612363088ad0bbc78abd233e8ace4c05a56fdabdd5e5e9b05e428bdaee,
                0x14748d0241710ef47f54b931ac5a58082b1d56b0f0c30d55fb71a6e8c9a6be14,
                0xb59baa35b9dc267744f0ccb4e3b0255c1fc512460d91130c6bc19fb2668568d,
                0x2c45bb0c3d5bc1dc98e0baef09ff46d18c1a451e724f41c2b675549bb5c80e59,
                0x121468e6710bf1ffec6d0f26743afe6f88ef55dab40b83ca0a39bc44b196374c,
                0x2042c32c823a7440ceb6c342f9125f1fe426b02c527cd8fb28c85d02b705e759,
                0xd582c10ff8115413aa5b70564fdd2f3cefe1f33a1e43a47bc495081e91e73e5,
                0xf55a0d491a9da093eb999fa0dffaf904620cbc78d07e63c6f795c5c7512b523,
                0x21849764e1aa64b83a69e39d27eedaec2a8f97066e5ddb74634ffdb11388dd9a,
                0x2e33ee2008411c04b99c24b313513d097a0d21a5040b6193d1f978b8226892d6,
                0x1fd848aa69e1633722fe249a5b7f53b094f1c9cef9f5c694b073fd1cc5850dfb,
                0x1a180441acbe2e25177de322888800476d75191e3c2c753300dedf84de7d2053,
                0x2ac5dda169f6bb3b9ca09bbac34e14c94d1654597db740153a1288d859a8a30a,
                0x2de9cf8ca22a0c9f7ac822564e7e90726457ffdee6107772e7461aa6dacf876d,
                0x15e4cf322bd4693b5ba17d7d77599ed6b40e943b15d4b652dcd1b206f57a4c6e,
                0x2f79c24831208eb014af76127ee58b95cf9598ad1dad9c82e19f10b7fee8f6f,
                0x19d4d18c572a9b0b503094e1de87b8594e1d37dd1da42acdb3a19bd35f005a3a,
                0x24d3e3c36e11f6dac11d08927f0a925e2c4c42248a913c18da9f5cc0da73836a,
                0x131b0345b2f2564b2338810cd8d7b90a8d5a2fcc1a9a8876a494dbe3c8135c6c,
                0xe765e363b659fafffce80bef02723bbbea3669cc9b07f327b4fc9c959c169a5,
                0xf2d774b6dc7c8c6c49e2056f9f9e77d510637ff52368027fd8326821c83445a,
                0x16599e0bb19201fa33d4c00c3f7c5189552a26038ee219b1c8b08fd1b16ecd52,
                0x22f62d7c8204be97acc7644d4b14a422c17e573506e900a4788acbfb8c8b1aba,
                0x691a1f6e7dd363914d2754f434659383019fe2a1d10a9ce92d152decccfc5f5,
                0x1250a6bd4582016e8af7d74a31a7d181864326e50cea97f643b70ec9d94e1efc,
                0x2d2011d328f63f5cb9eb68a6806f8ce624ceb84a876a390fda61d6d6bb5a530,
                0x1b593cc9332c0bb29333e5833284e18e765bb17fc0a7718f6b21d8a833a0765b,
                0x19bffd7d85c0863485890e50a717ebb21d4b888f0268d9c7258a3db25f969d9,
                0x12340d5bb49b5667c9194321fc364488d0f082a8fb1bc4f1b96359209b1bf110,
                0x2209d88df4bf41b2e002ff46f8ac45aa4ec8b222f4551c178fe50f99b505681f,
                0x4f95f7efd61e5dfab009860f0e53b7e65686c5dbb1b1a800d597ec130836f92,
                0x74b0f589c0d62b3ee0d70fd057f9d0e143a6b888d0a9f60ac1d0f1c77ddf863,
                0x5e7d0fbf97820e4f7e37899bee6f967bc67f5b396f760665eb5ce76f51cff90,
                0xee294cdea89cdfb6a3fd3f85316222c2e6e7482b9cd052cea388141037acdb5,
                0x73f3f1b95b5cafa069fe1bb5e08c8586775783cc6a11c35ab0107dbd0437dd6,
                0x12a604345e9442be58176866c68899249a7c14a777af0938a759826474ebb215,
                0xb983d964a33bdccf941858b4eed650917cc9c35265f14ec2715dc6999c0489,
                0x1a1a7fbdc860bcc40d4b3eea4c8f469f991050b9fb6ef33ca3694edc4f36a82b,
                0xdf2ad5009b0aa7b9cc62d10f9fddc978e28452ef5f3bb3d274743359383592b,
                0x16e0518517026f2c7cbf14301679bcecd00e8babaf0bda664c49b02dcda6b4dd,
                0x205e35d27e9528e137e8f93ff50b877d6f0fa3230e1215df6360ef7ca4b3680a,
                0x2b14a855c417e66c86c9e1bd864e0a5b00d45bbe84e6d93749ef109d25790d9d,
                0x2cde883b4ec6916a780528e64ab784c3c081ed2d71397c5d739a5bd4f24a8e3c,
                0x1bf2b15c37a3eb5f94bbf12c10e19a22f3c8ddde72133d9fe32db2be7387a77c,
                0x1fd2be106c935c189640b47d2ad9deb51ff348845b7e6cf0eca562435735fa67,
                0x3029a5ede685ae7e42e029a4f1b22a0575d6b5cef84f695a2f987ede9fe41280,
                0x2c16523888340ddb03fff41ab7a56b492c345a76411e5d3467360264cc5f67,
                0x2c6d19a82f4a7679d929c99dbbe056cf07e74fe0460e9d5b81226b9b2283d96d,
                0x2c5164b5c7798ae26796f2374fe1acace1a69b5772352fdd9c09e83b95847e75,
                0xd31f8f2a4e34d6731f1042d995d4ab9b3f9dc01e033446521947534ed617886,
                0x1f1a7feb56222e6eb83bf3beb69f5efcc05d10c2cff3d6c3f5b8134943ef678e,
                0x24c4aca03d4a952cc1b2879b1241b0669afde82390de9fc8edad89c2fda41014,
                0x1c0857ed41b1a306a787fd591e14f0190c7332745112e4d4aaa4f71fcdb18b1e,
                0x145e3cb92e0058bc04394485e73dd1f9ba87c2cc15a3b201c027e43109dbef81,
                0x26e0aeb64465f3ad7046be46afc13c942be769135549b36c833947b4e0da69df,
                0x21f428f358cce02f84038fd4cbd838dabd72b8ceed847cde16375f1c98ab81fd,
                0xc3e112a2286b468499a5ea53e050bcb848dc0f70c7d758c7602e327746a063b,
                0x291d939f9e3a70af5d6d2d8caffc34175cbfab587d4e9e293821806149453d9e,
                0x2e81f77acaf016b7fc5567d50a96773c72743783e7bba0e5a12a4a135485a49f,
                0x12e0e08c58426173229fb99e97a35c8f75a8c4f30ec5ed8fbe7b00c81765c2ec,
                0x25ee0b3dc3db03f85b355d34f156066cc1ad50112589092d90de8ebb4017d116,
                0xb29d0ddf485319a9bfbf6b263e865a67c6122e7f47ecc482f591f92e4effaf4,
                0x140f26545084fcd739e0abf03a75d1c889b8dd99818e9ae23ed638a63fee2191,
                0x2fb6de61ff780b7274373cb13232d4c9ad8487c6ebb1e3121a16ddec2c4b624c,
                0x854275e7235881668b5b98251a66d8c9b82af0a6451da41d0eac04d4e7811c8,
                0x822679ef57fef500de54d6cba8415ce9ac944d3afb1dd4cacce2b2ff451403f,
                0x1d0ca0d26b8051fcceaedb7a95f25c4cd5e71ffce3ae1f2942c3612c8f6e80a8,
                0x2353d576c4d9f118a4bc7b2c492f7164cf173bc2c37d17f7fa6126c7d0094927,
                0x188e9347138c524bda0413d4ad63350c88ba806491204abd61a285d192d50e14,
                0x126c2038a88263356a46f4de9a59b538df61a3c4cedee042ba66193debf0d4b7,
                0x1b34d0aba99f650468f0d3241fab6192755b6ee17d345f3c23f784c365e97e52,
                0x13f60d322ff331eeb58a3c85acc593c97f8930c1f07e92b9c19772ba6f185221,
                0x10d2b5662f6977c2cf9b23c1d7dfce6a56ccc7baf7bc7b2cbb505368828888c1,
                0x1000b1532ad15dab1910284d08588e0ed96b09a95a7b06180bd40f3e43041aa4,
                0xe4425e6397061fb0a1cb79d4861ee8e780ec260783d6462dda5109cf13e0311,
                0x13999b236cd8cb12546b95e2234e5e92f2dbe1ea227ee7ff9477896864d9c26f,
                0x16253ee85a590b7d7e450d3ef38b6d8d72e57d7985d98fdae9d3e69d280e1490,
                0x849dd12c0483e541856ebf80f3fe755a4f4cbc02a3921c2909d04890f9ce86b,
                0x2f4f55d48db9c60e9b822552c9db290c03cfa51fe52e0980f99fd882bd2e0065,
                0x26e9c4c282f2aba00a3f528e04abab1e63df8a908636c7295a4f67135c986e75,
                0x1d5717b6a1d0d20e41d35e2c7d0b4fa001924d91618550026106b4fc2b978b9e,
                0x16276c3116072ae2d3815ebef6eae3c7418641bc048667418409cb1a36a3c6bd,
                0x200ace77e0d131b2652e782f50136c4f3e7bd21b7342327715ae96796b0e4785,
                0x303f0d0ee0cfc4509ac0174c85aad3ee1aab586e90b118f8de5aa446d2aec8ca,
                0x21d023dac5b44bad38d5b4f08ecc711cc9f9a916ee3a8e9e406236cef888f7e8,
                0x1ee0da36a81b54a9eef3b4b0a1b2f8d697855a48b8db44478aa2383eb635b218,
                0x2dbabb204983acc8179b7b3242862961b174d22f4fefcd81e68c6549c9a88cea,
                0x23954e35feba58a113fa213392abd035c2b032f0b4e83c2f52a83d18e54433bc,
                0x2aed396db05f304fc6775f10e0aa0dceeefe297e511ad478414eb1ab84844957,
                0x25221fd64e70bb4c90b30a2fb1852ddaa8704ba4680584651c3c9732f501e138,
                0x4e4fe96e487b1979011964d97719275a68773ee23ba55fe2f809d69c10c3a22,
                0x2c212b4c639445a6c03ea31cc755c51433c61afbed9eea3556b36f27cdf344a6,
                0x249a023bda5b6a8d6b1e3d994693cdd3ad81f0282b95d5a15ddc36b195138e4e,
                0x156b5cd887b306896b7ca039e2afa02868ba62817d7b7e5d2896ae14e1a9a7e5,
                0x162d3e89ec9131809bc10150382a744f65af577521cc37c46bd00912f3eb4d31,
                0x22075061e5564be974e193731c06a4e22cfc8242a38180c732ad2f0d4604e3fe,
                0xb6b9c320f299ad3afd75f0d0bd81afbb0e757f8307f61978d5de7817f608327,
                0x506e0a856c856e7634ab226160b6a323261a3e0c8810f68e2743a4263b57ee2,
                0x2413c3e2b026ffff5628832762082690520fc5a22f825e3af1a86cc435901981,
                0x2cef9a3613e8172d950b3c1cb7cab1224277ad2712ac02e96dc8519794a8ad5f,
                0xf636c6a10dbda008e10895d5b588f5b5d01a5da3a09c361c1a0b548b560b220,
                0x18c09a08d500307171b4f240ce0f2c5e78866ec7e6374a0176047fa890fba0ff,
                0xa3cc6a6411731de29dc727f71370d6c9ad89980d868ed69220b8807e76c9f1a,
                0x199c7b72643a56c5dacc094c5ab51c19ea6d4e2ab5067abd873cfd728483ee3a,
                0xa9c91ec9d961021c7f3e816b9aa9a04257acde68474586c8a9d9d5c940807e8,
                0x14c5fd147f901e87ded8a14a4fc59939bfb72af7f7e67186e733fe9bb2d03eca,
                0x1acef925c3cca5dc9f0a031563d268374fdb1719c59b743c7ee6667ef6879399,
                0xea860a77c1c5de892c3659365c610d079fa8d064fc0982291d5b2313505b8a2,
                0xcf81c182313729421c7b9a627208a70acde524a61589b88630842aec4151fbe,
                0x3c1dd4555254c7c2663290bee910ae8f7359fe0cc45e306a9df149b9583fc28,
                0x2380880753bc787886c9330c047d222cc2a90ac6be2fe1bbe69c3be7c83c7b0e,
                0x1db6521a766a6d998d0502d2543209962f3352d55e72b29656bfc3d7e2a250d8,
                0x5c4aa57c046dd90cdccc970263f2dec18fa0dac5108e96d9ef1511758d3d191,
                0xc879e4b1793ca7ad312adf8d83aa14a3b7df00eff18e9e9b8d1da21dc0b3033,
                0x2f234d5aab8610df7b41caf56ed7db37efde646138f699c64da49313f944b20b,
                0x2abb52222822ff819894aa1506aceb69cdd387abb73d541f1e8ba8f971fb4375,
                0x1d9472930835607a1a5543cc38ab10b3db29aa5bd46d779548a05927fae2531c,
                0x22b45ca22855701aa0ecb8609bdc31390e8c94cd9935202ed90d90c07e5f6c67,
                0xa1f39f29473f6a16b502a67dc2683705e177ef3763ca210b36a6222f201928c,
                0x156cc79f3ce078aad6e5696dca53bd414daee13f69b6e1843927981c36505697,
                0x228e1ea054fd72054b743d4d83e8cb1fd688fcf6e988b79cd73c590befbea8c8,
                0x26b7327ab922821bd4f8140cce34ff4ccea50fbc5422ae813c2656408cce3a70,
                0x1f88cb99931d78883fc9390abb33404b4b7d45ab032cfabf43c2cba6bf04924c,
                0x2c9a9e3033be9def3f405a74334e13abda0a9bf0e2dded80e07464946626163c,
                0x1ffba91116956a6d7499ce126e4d007b26ba57aa42ca8d260b1e6cd7f38541c5,
                0x4d01766bf4af18c1c993689ba59328da95a06be98204edda80174720e47b975,
                0xa3a44d64bcf0c2b158912d887c5993e9568331b7249d98aed3e143c555bee34,
                0x1b03b3acfb879340d7ded90a8a34d6aaa567e052a02fde21942fee82e8f66410,
                0x26fa331c2375a0bb32aa7f2084a5ff100db2398c10a3415fb1d082dffd478794,
                0x27db7d141d06b30011b01150c3a4e29bb43e22eed0d8c7e73219256fad9255f8,
            ],
        ]
    "#]];
    expected_paths.assert_debug_eq(&res.paths);
}
